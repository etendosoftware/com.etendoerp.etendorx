<?xml version="1.0"?>
  <database name="FUNCTION ETRX_ROLE_ORGANIZATIONS">
    <function name="ETRX_ROLE_ORGANIZATIONS" type="VARCHAR">
      <parameter name="p_ad_client_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <parameter name="p_ad_role_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <parameter name="p_mode" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[v_org_ids varchar(32)[];
	v_new_ids varchar(32)[];
BEGIN
    -- Get active organizations for a given role
	SELECT array_agg(t.ad_org_id) INTO v_org_ids
    FROM ad_org_tree t
    WHERE t.isactive = 'Y'
	AND t.ad_client_id = p_ad_client_id 
	AND t.ad_org_id in (select ad_org_id from ad_role_orgaccess where ad_role_id = p_ad_role_id);
	
    -- If "0" is in the list, fetch all organizations
    IF v_org_ids is null THEN
        SELECT array_agg(o.ad_org_id) INTO v_org_ids
        FROM ad_org o
        WHERE o.isactive = 'Y'
		AND o.ad_client_id = p_ad_client_id ;
    ELSE
        -- Fetch organizations under each organization in v_org_ids
        FOR i IN 1 .. array_length(v_org_ids, 1)
        LOOP
            -- Call a function get_natural_tree which returns a list of all orgs under a certain org
            v_new_ids := array(select distinct unnest(v_org_ids || get_natural_tree_loop(v_org_ids[i], p_ad_client_id)));
        END LOOP;
    END IF;
	v_org_ids := v_org_ids || v_new_ids;
    -- Add "0" to the list
    v_org_ids := array_append(v_org_ids, '0');

    RETURN array(select distinct unnest(v_org_ids));
END ETRX_ROLE_ORGANIZATIONS
]]></body>
    </function>
  </database>
